# Backend Service API

The backend service exposes HTTP endpoints for integrations with trading frontends, risk dashboards, and automation systems. All responses are JSON encoded.

## REST Endpoints

| Method | Path                     | Description                     |
| ------ | ------------------------ | ------------------------------- |
| POST   | `/positions/open`        | Open a new leveraged position   |
| PUT    | `/positions/:id/modify`  | Modify an existing position     |
| DELETE | `/positions/:id/close`   | Close a position                |
| GET    | `/positions/:id`         | Retrieve a single position      |
| GET    | `/users/:id/positions`   | List all positions for a user   |

### `POST /positions/open`
```json
{
  "symbol": "BTC-PERP",
  "side": "long",
  "size": "0.5",
  "leverage": 50,
  "entry_price": "65000",
  "client_position_id": 1234
}
```

### `PUT /positions/:id/modify`
```json
{
  "action": "increase_size",
  "execution_price": "65500",
  "delta_size": "0.1",
  "funding_payment": "0"
}
```

`action` can be `increase_size`, `decrease_size`, `add_margin`, or `remove_margin`. Depending on the action, one of `delta_size` or `margin_delta` must be provided.

### `DELETE /positions/:id/close`
```json
{
  "execution_price": "64000",
  "funding_payment": "-2.5"
}
```

### `GET /positions/:id`
Returns the persisted position view if available.

### `GET /users/:id/positions`
Responds with all cached positions for the specified user and aggregate collateral figures.

## WebSocket Streams

A production implementation would push the following channels via WebSocket or gRPC streaming:

* `positions.<owner>` — incremental position updates.
* `pnl.<owner>` — real-time unrealized/realized PnL changes.
* `alerts.liquidation` — margin ratio alerts generated by the `MetricsEmitter`.

## Internal Integrations

* **Liquidation Engine**: consumes margin alerts and issues close transactions.
* **Funding Rate Engine**: supplies periodic funding payments that are applied during modifications.
* **Settlement Relayer**: replays confirmed Solana transactions to reconcile on-chain state with the cache.
